<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Pulse - Painel do Operador (Corrigido)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .header-title {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .header-subtitle {
            font-size: 14px;
            color: #666;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .icon-blue { background: #e8f4f8; }
        .icon-yellow { background: #fff8e8; }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-addon {
            padding: 12px 16px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .news-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .news-item {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .news-item:hover {
            border-color: #3498db;
            background: #e8f4f8;
        }

        .news-item.selected {
            border-color: #3498db;
            background: #e8f4f8;
        }

        .news-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .news-asset {
            font-size: 12px;
            font-weight: bold;
            color: #3498db;
        }

        .news-impact {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: bold;
        }

        .impact-positive {
            background: #e8f5e9;
            color: #27ae60;
        }

        .impact-negative {
            background: #ffebee;
            color: #e74c3c;
        }

        .impact-neutral {
            background: #f5f5f5;
            color: #666;
        }

        .news-title {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
        }

        .history-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        /* AJUSTE 1: Header do histórico para conter o botão */
        .history-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-list {
            max-height: 500px;
            overflow-y: auto;
            clear: both; /* Garante que a lista venha após o botão */
        }

        .history-item {
            padding: 15px;
            padding-bottom: 15px; /* Mais espaço para o botão delete */
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 12px;
            position: relative; 
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-type {
            font-size: 12px;
            font-weight: bold;
            color: #3498db;
        }

        .history-time {
            font-size: 11px;
            color: #999;
        }

        .history-content {
            font-size: 13px;
            color: #333;
            margin-bottom: 6px;
        }

        .history-meta {
            font-size: 11px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .back-btn {
            background: white;
            color: #3498db;
            padding: 12px 24px;
            border-radius: 10px;
            border: 2px solid #3498db;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: #e8f4f8;
        }

        .alert-preview {
            background: #fff8e8;
            border: 2px solid #f39c12;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .alert-preview-title {
            font-size: 12px;
            font-weight: bold;
            color: #f39c12;
            margin-bottom: 10px;
        }

        .alert-preview-content {
            font-size: 13px;
            color: #333;
        }

        .info-badge {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #856404;
        }

        .gap-status {
            background: #e8f5e9;
            border: 1px solid #27ae60;
            border-radius: 6px;
            padding: 8px;
            margin-top: 10px;
            font-size: 11px;
            color: #1e7e34;
            display: none;
        }

        .gap-status.show { display: block; }

        /* AJUSTE 2: Posição do botão delete */
        .delete-btn {
            position: absolute;
            bottom: 10px; /* Inferior */
            right: 10px;  /* Esquerda */
            padding: 5px 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 10px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        /* AJUSTE 1: Posição do botão apagar histórico */
        .clear-history-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            width: auto; 
            float: left; /* Alinha à esquerda */
        }

        .clear-history-btn:hover {
            background: #c0392b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 300px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-btn {
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .modal-btn.yes { background: #27ae60; color: white; }
        .modal-btn.no { background: #e74c3c; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" onclick="goBack()">← Voltar para Seed Database</button>

        <div class="header">
            <div class="header-title">👨‍💼 Painel do Operador - Market Pulse</div>
            <div class="header-subtitle">Envie alertas de variação de preço e notícias para os usuários</div>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">Total de Alertas Enviados</div>
                <div class="stat-value" id="totalDispatches">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Alertas Cadastrados (Usuários)</div>
                <div class="stat-value" id="totalUserAlerts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Notificações Geradas</div>
                <div class="stat-value" id="totalNotifications">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Usuários Ativos</div>
                <div class="stat-value" id="totalUsers">0</div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Painel de Variação de Preço -->
            <div class="panel-card">
                <div class="panel-title">
                    <div class="panel-icon icon-blue">📊</div>
                    Enviar Variação de Preço
                </div>

                <div class="info-badge">
                    ⚡ <strong>Sistema Automático:</strong> Insira apenas o preço atual. O sistema busca o último preço automaticamente, calcula a variação %, atualiza indicadores, gera análise fundamentalista e preenche gaps!
                </div>

                <div class="form-group">
                    <label class="form-label">Selecionar Ativo</label>
                    <select class="form-control" id="priceAsset" onchange="updatePricePreview()">
                        <option value="">Escolha um ativo</option>
                        <option value="PETR4">PETR4 - Petrobras PN</option>
                        <option value="VALE3">VALE3 - Vale ON</option>
                        <option value="ITUB4">ITUB4 - Itaú Unibanco PN</option>
                        <option value="BBDC4">BBDC4 - Bradesco PN</option>
                        <option value="ABEV3">ABEV3 - Ambev ON</option>
                        <option value="WEGE3">WEGE3 - WEG ON</option>
                        <option value="MGLU3">MGLU3 - Magazine Luiza ON</option>
                        <option value="B3SA3">B3SA3 - B3 ON</option>
                        <option value="SUZB3">SUZB3 - Suzano ON</option>
                        <option value="RENT3">RENT3 - Localiza ON</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Preço Atual (R$)</label>
                    <div class="input-group">
                        <div class="input-addon">R$</div>
                        <input type="number" class="form-control" id="priceNew" 
                               placeholder="Ex: 35.50" step="0.01" oninput="updatePricePreview()">
                    </div>
                </div>

                <div class="alert-preview" id="pricePreview" style="display: none;">
                    <div class="alert-preview-title">📋 Preview do Alerta</div>
                    <div class="alert-preview-content" id="pricePreviewContent"></div>
                    <div class="gap-status" id="gapStatus"></div>
                </div>

                <button class="btn btn-primary" onclick="sendPriceAlert()" id="sendPriceBtn" disabled>
                    📤 Enviar Alerta
                </button>
            </div>

            <!-- Painel de Notícias (Perfeito, sem alterações) -->
            <div class="panel-card">
                <div class="panel-title">
                    <div class="panel-icon icon-yellow">📰</div>
                    Enviar Notícia
                </div>

                <div class="form-group">
                    <label class="form-label">Buscar Notícia</label>
                    <input type="text" class="form-control" id="newsSearch" 
                           placeholder="Busque por título, ativo ou setor" oninput="filterNews()">
                </div>

                <div class="news-list" id="newsList"></div>

                <button class="btn btn-success" id="sendNewsBtn" onclick="sendNewsAlert()" disabled>
                    📤 Enviar Notícia Selecionada
                </button>
            </div>
        </div>

        <!-- Histórico (Layout Ajustado) -->
        <div class="history-card">
            <!-- AJUSTE 1: Posição do botão Apagar Histórico -->
            <div class="history-header-bar">
                <div class="panel-title">
                    <div class="panel-icon icon-blue">📜</div>
                    Histórico de Envios
                </div>
                <button class="clear-history-btn" onclick="showClearHistoryModal()">Apagar Histórico</button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>

        <!-- Modal de confirmação para apagar histórico -->
        <div id="clearHistoryModal" class="modal">
            <div class="modal-content">
                <p>Confirma a exclusão do histórico?</p>
                <button class="modal-btn yes" onclick="clearHistory()">Sim</button>
                <button class="modal-btn no" onclick="hideClearHistoryModal()">Não</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // DADOS GLOBAIS
        // ========================================
        let selectedNewsId = null;
        let allNews = [];

        // ========================================
        // HYBRIDENGINE (VERSÃO CORRIGIDA v3)
        // Engine única para processar alertas de preço e notícias
        // ========================================
        const HybridEngine = {
            
            // --- Funções de Preço ---
            sendPriceUpdate(asset, newPrice) {
                const now = Date.now();
                const historical = JSON.parse(localStorage.getItem(`marketPulse_historical_${asset}`) || '[]');
                let oldPrice;
                let gapsGenerated = 0;

                if (historical.length > 0) {
                    oldPrice = historical[historical.length - 1].close;
                    const lastUpdateTime = historical[historical.length - 1].timestamp;
                    const timeDiff = now - lastUpdateTime;
                    const hoursDiff = timeDiff / (1000 * 60 * 60);
                    const gapsNeeded = Math.floor(hoursDiff / 4);

                    if (gapsNeeded > 0) {
                        gapsGenerated = gapsNeeded;
                        const priceStep = (newPrice - oldPrice) / (gapsNeeded + 1);
                        for (let i = 1; i <= gapsNeeded; i++) {
                            const gapTime = lastUpdateTime + (i * 4 * 60 * 60 * 1000);
                            const gapPrice = oldPrice + (priceStep * i);
                            historical.push({
                                timestamp: gapTime,
                                close: gapPrice
                            });
                        }
                    }
                } else {
                    oldPrice = this.getBasePrice(asset);
                }

                const variation = ((newPrice - oldPrice) / oldPrice) * 100;
                
                // Cria o objeto de dispatch
                const dispatch = {
                    id: now + Math.random().toString(36).substr(2, 9),
                    type: 'price',
                    asset: asset,
                    variation: variation,
                    oldPrice: oldPrice,
                    newPrice: newPrice,
                    timestamp: now,
                    operator: 'admin'
                };

                // Salva histórico
                historical.push({
                    timestamp: now,
                    close: newPrice
                });
                localStorage.setItem(`marketPulse_historical_${asset}`, JSON.stringify(historical));

                // Gera e salva análise
                const analysis = this.generateAnalysis(asset, newPrice, variation);
                const reports = JSON.parse(localStorage.getItem('marketPulse_analysis_reports') || '{}');
                reports[asset] = analysis;
                localStorage.setItem('marketPulse_analysis_reports', JSON.stringify(reports));

                // Salva update (para referência interna)
                const updates = JSON.parse(localStorage.getItem('marketPulse_price_updates') || '[]');
                updates.push(dispatch);
                localStorage.setItem('marketPulse_price_updates', JSON.stringify(updates));

                // ***** INÍCIO DA CORREÇÃO (Problema 3) *****
                // 1. Salva o dispatch principal (usado pelo histórico)
                const dispatches = JSON.parse(localStorage.getItem('marketPulse_dispatches') || '[]');
                dispatches.push(dispatch);
                localStorage.setItem('marketPulse_dispatches', JSON.stringify(dispatches));

                // 2. Processa o matching (APENAS UMA VEZ)
                this.processAlertMatching(dispatch); 
                // ***** FIM DA CORREÇÃO *****

                return {
                    update: dispatch, // Retorna o dispatch criado
                    gapsGenerated,
                    analysis
                };
            },

            // --- Funções de Notícia (Movidas do DispatchEngine) ---
            sendNewsUpdate(newsId) {
                const now = Date.now();
                const allNews = JSON.parse(localStorage.getItem('marketPulse_news') || '[]');
                const newsIndex = allNews.findIndex(n => n.id === newsId);

                if (newsIndex === -1) return null;

                // Atualiza o timestamp da notícia original
                allNews[newsIndex].timestamp = now;
                localStorage.setItem('marketPulse_news', JSON.stringify(allNews));

                // Cria o objeto de dispatch
                const dispatch = {
                    id: now + Math.random().toString(36).substr(2, 9),
                    type: 'news',
                    asset: allNews[newsIndex].company,
                    newsId: newsId,
                    newsTitle: allNews[newsIndex].title,
                    newsImpact: allNews[newsIndex].impact, // Adicionado para consistência
                    timestamp: now,
                    operator: 'admin'
                };

                // Salva o dispatch principal (usado pelo histórico)
                const dispatches = JSON.parse(localStorage.getItem('marketPulse_dispatches') || '[]');
                dispatches.push(dispatch);
                localStorage.setItem('marketPulse_dispatches', JSON.stringify(dispatches));

                // Processa o matching (APENAS UMA VEZ)
                this.processAlertMatching(dispatch);

                return dispatch;
            },


            // --- Funções de Matching (Centralizadas) ---
            processAlertMatching(dispatch) {
                const allAlerts = JSON.parse(localStorage.getItem('marketPulse_alerts') || '[]');
                const activeAlerts = allAlerts.filter(a => a.active && a.asset === dispatch.asset);

                console.log(`[HybridEngine] 🔍 Processando matching para ${dispatch.asset}:`, dispatch.type);

                let notificationsCreated = 0;

                activeAlerts.forEach(alert => {
                    let shouldNotify = false;

                    if (dispatch.type === 'price' && alert.type === 'price') {
                        const variation = dispatch.variation;
                        const threshold = alert.variationPercentage || 0;
                        if (variation > 0 && threshold > 0 && variation >= threshold) shouldNotify = true;
                        else if (variation < 0 && threshold < 0 && variation <= threshold) shouldNotify = true;
                    
                    } else if (dispatch.type === 'news' && alert.type === 'news') { 
                        shouldNotify = true;
                    }

                    if (shouldNotify) {
                        this.createUserNotification(alert, dispatch);
                        notificationsCreated++;
                        
                        const alertIndex = allAlerts.findIndex(a => a.id === alert.id);
                        if (alertIndex !== -1) {
                            allAlerts[alertIndex].triggeredCount = (allAlerts[alertIndex].triggeredCount || 0) + 1;
                        }
                    }
                });

                localStorage.setItem('marketPulse_alerts', JSON.stringify(allAlerts));
                console.log(`[HybridEngine] 📊 Matching completo: ${notificationsCreated} notificações criadas`);
            },

            createUserNotification(alert, dispatch) {
                const userId = alert.userId;
                const now = Date.now(); 
                const notifications = JSON.parse(localStorage.getItem(`marketPulse_notifications_${userId}`) || '[]');
                let notification;

                if (dispatch.type === 'price') {
                    notification = {
                        id: now + Math.random(), 
                        userId: userId,
                        type: 'alert',
                        alertType: 'price',
                        alertId: alert.id,
                        asset: dispatch.asset,
                        assetName: alert.assetName,
                        title: dispatch.asset,
                        message: `${dispatch.variation >= 0 ? '+' : ''}${dispatch.variation.toFixed(1)}% • R$ ${dispatch.newPrice.toFixed(2)}`,
                        description: 'Variação de preço atingiu seu alerta',
                        read: false,
                        timestamp: now, 
                        dispatchTimestamp: dispatch.timestamp,
                        originalVariation: dispatch.variation,
                        originalPrice: dispatch.newPrice,
                        matchedCondition: alert.condition
                    };
                } else { // Notícia
                    notification = {
                        id: now + Math.random(),
                        userId: userId,
                        type: 'alert',
                        alertType: 'news',
                        alertId: alert.id,
                        newsId: dispatch.newsId,
                        asset: dispatch.asset,
                        assetName: alert.assetName,
                        title: dispatch.asset,
                        message: dispatch.newsTitle.substring(0, 60) + '...',
                        description: `Nova notícia: ${dispatch.newsImpact === 'positive' ? 'Positiva' : dispatch.newsImpact === 'negative' ? 'Negativa' : 'Neutra'}`,
                        read: false,
                        timestamp: now, 
                        dispatchTimestamp: dispatch.timestamp
                    };
                }

                notifications.unshift(notification);
                localStorage.setItem(`marketPulse_notifications_${userId}`, JSON.stringify(notifications));
                console.log(`[HybridEngine] ✅ Notificação criada:`, { user: userId, asset: dispatch.asset, type: dispatch.type });
            },

            // --- Funções Auxiliares ---
            getBasePrice(asset) {
                const bases = {
                    'PETR4': 35.50, 'VALE3': 62.30, 'ITUB4': 28.50, 'BBDC4': 13.20,
                    'ABEV3': 14.20, 'WEGE3': 38.50, 'MGLU3': 3.45, 'B3SA3': 12.80,
                    'SUZB3': 52.70, 'RENT3': 45.80
                };
                return bases[asset] || 30.00;
            },

            generateAnalysis(asset, currentPrice, variation) {
                const isPositive = variation > 1;
                const isNegative = variation < -1;
                const confidence = Math.floor(Math.random() * 20 + 80);
                const oldSentiment = JSON.parse(localStorage.getItem('marketPulse_analysis_reports') || '{}')[asset]?.sentiment || { history: [] };
                const predicted = Math.random() > 0.5 ? 'altista' : 'baixista';
                const actual = isPositive ? 'altista' : isNegative ? 'baixista' : 'neutro';
                const accuracy = (oldSentiment.history.filter(h => h.correct).length / (oldSentiment.history.length + 1) * 100) || 100;

                oldSentiment.history.push({ predicted, actual, correct: predicted === actual });

                return {
                    symbol: asset,
                    name: this.getAssetName(asset),
                    updatedAt: Date.now(),
                    currentPrice: currentPrice,
                    priceChange: variation,
                    technicalAnalysis: {
                        trend: isPositive ? 'Altista' : isNegative ? 'Baixista' : 'Lateral',
                        support: currentPrice * 0.92,
                        resistance: currentPrice * 1.08,
                        recommendation: isPositive ? 'COMPRA' : isNegative ? 'VENDA' : 'MANTER',
                        confidence: confidence,
                        indicators: {
                            rsi: Math.floor(Math.random() * 40 + 40),
                            macd: isPositive ? 'Positivo' : 'Negativo',
                            bollinger: isPositive ? 'Próximo ao topo' : 'Próximo ao fundo'
                        }
                    },
                    fundamentalAnalysis: {
                        pe: parseFloat((Math.random() * 10 + 5).toFixed(1)),
                        dividendYield: parseFloat((Math.random() * 8 + 4).toFixed(1)),
                        roe: parseFloat((Math.random() * 15 + 10).toFixed(1)),
                        debtEquity: parseFloat((Math.random() * 0.5 + 0.2).toFixed(2)),
                        recommendation: isPositive ? 'COMPRA' : 'MANTER',
                        targetPrice: currentPrice * (isPositive ? 1.15 : 1.05)
                    },
                    sentiment: {
                        predicted: predicted,
                        actual: actual,
                        accuracy: accuracy,
                        confidence: confidence,
                        history: oldSentiment.history
                    },
                    summary: `${this.getAssetName(asset)} apresenta ${isPositive ? 'fundamentos sólidos' : 'desafios operacionais'} com ${isPositive ? 'forte' : 'moderada'} geração de caixa. Recomendação: ${isPositive ? 'COMPRA' : 'MANTER'}.`,
                    risks: `Volatilidade no setor, mudanças regulatórias e concorrência podem impactar negativamente.`,
                    opportunities: `${isPositive ? 'Crescimento' : 'Recuperação'} no setor, dividendos ${isPositive ? 'atrativos' : 'consistentes'} e possível valorização.`
                };
            },

            getAssetName(symbol) {
                const names = {
                    'PETR4': 'Petrobras PN',
                    'VALE3': 'Vale ON',
                    'ITUB4': 'Itaú Unibanco PN',
                    'BBDC4': 'Bradesco PN',
                    'ABEV3': 'Ambev ON',
                    'WEGE3': 'WEG ON',
                    'MGLU3': 'Magazine Luiza ON',
                    'B3SA3': 'B3 ON',
                    'SUZB3': 'Suzano ON',
                    'RENT3': 'Localiza ON'
                };
                return names[symbol] || symbol;
            }
        };

        // ========================================
        // (REMOVIDO) DISPATCH ENGINE 
        // A lógica foi centralizada no HybridEngine
        // ========================================

        // ========================================
        // LOAD DATA
        // ========================================
        function loadData() {
            const dispatches = JSON.parse(localStorage.getItem('marketPulse_dispatches') || '[]');
            const allAlerts = JSON.parse(localStorage.getItem('marketPulse_alerts') || '[]');
            const users = JSON.parse(localStorage.getItem('marketPulse_users') || '[]');
            
            let totalNotifications = 0;
            users.forEach(user => {
                const notifs = JSON.parse(localStorage.getItem(`marketPulse_notifications_${user.id}`) || '[]');
                totalNotifications += notifs.length;
            });

            document.getElementById('totalDispatches').textContent = dispatches.length;
            document.getElementById('totalUserAlerts').textContent = allAlerts.length;
            document.getElementById('totalNotifications').textContent = totalNotifications;
            document.getElementById('totalUsers').textContent = users.length;

            allNews = JSON.parse(localStorage.getItem('marketPulse_news') || '[]');
            renderNewsList(allNews);
            loadHistory();
        }

        // ========================================
        // NEWS LIST (Sem alterações)
        // ========================================
        function renderNewsList(newsList) {
            const container = document.getElementById('newsList');
            
            if (newsList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📰</div>
                        <div>Nenhuma notícia encontrada</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = newsList.map(news => {
                const impactClass = news.impact === 'positive' ? 'impact-positive' : 
                                   news.impact === 'negative' ? 'impact-negative' : 'impact-neutral';
                const impactText = news.impact === 'positive' ? '✔ POSITIVA' : 
                                  news.impact === 'negative' ? '✕ NEGATIVA' : '∼ NEUTRA';
                
                return `
                    <div class="news-item ${selectedNewsId === news.id ? 'selected' : ''}" 
                         onclick="selectNews(${news.id})">
                        <div class="news-item-header">
                            <span class="news-asset">${news.company}</span>
                            <span class="news-impact ${impactClass}">${impactText}</span>
                        </div>
                        <div class="news-title">${news.title}</div>
                    </div>
                `;
            }).join('');
        }

        function filterNews() {
            const search = document.getElementById('newsSearch').value.toLowerCase();
            
            if (!search) {
                renderNewsList(allNews);
                return;
            }

            const filtered = allNews.filter(news => 
                news.title.toLowerCase().includes(search) ||
                news.company.toLowerCase().includes(search) ||
                (news.sector && news.sector.toLowerCase().includes(search))
            );

            renderNewsList(filtered);
        }

        function selectNews(newsId) {
            selectedNewsId = newsId;
            filterNews(); 
            document.getElementById('sendNewsBtn').disabled = false;
        }

        // ========================================
        // PRICE ALERT (Funções de UI)
        // ========================================
        function updatePricePreview() {
            const asset = document.getElementById('priceAsset').value;
            const newPrice = parseFloat(document.getElementById('priceNew').value);
            const preview = document.getElementById('pricePreview');
            const previewContent = document.getElementById('pricePreviewContent');
            const gapStatus = document.getElementById('gapStatus');

            if (!asset || isNaN(newPrice)) {
                preview.style.display = 'none';
                document.getElementById('sendPriceBtn').disabled = true;
                return;
            }

            const historical = JSON.parse(localStorage.getItem(`marketPulse_historical_${asset}`) || '[]');
            let oldPrice;

            if (historical.length > 0) {
                oldPrice = historical[historical.length - 1].close;
            } else {
                oldPrice = HybridEngine.getBasePrice(asset);
            }

            const variation = ((newPrice - oldPrice) / oldPrice) * 100;
            const sign = variation >= 0 ? '+' : '';
            const arrow = variation >= 0 ? '▲' : '▼';

            previewContent.innerHTML = `
                <strong>${asset}</strong><br>
                Preço Anterior: R$ ${oldPrice.toFixed(2)}<br>
                Preço Atual: R$ ${newPrice.toFixed(2)}<br>
                ${arrow} <strong>${sign}${variation.toFixed(2)}%</strong>
            `;

            const lastUpdate = historical[historical.length - 1];
            const timeSinceLastUpdate = lastUpdate ? Date.now() - lastUpdate.timestamp : 0;
            const hoursSinceUpdate = timeSinceLastUpdate / (1000 * 60 * 60);
            const gapsNeeded = hoursSinceUpdate > 4 ? Math.floor(hoursSinceUpdate / 4) : 0;

            if (gapsNeeded > 0) {
                gapStatus.innerHTML = `
                    ⚡ <strong>Gap Protection:</strong> Serão gerados ${gapsNeeded} pontos intermediários
                `;
                gapStatus.classList.add('show');
            } else {
                gapStatus.classList.remove('show');
            }

            preview.style.display = 'block';
            document.getElementById('sendPriceBtn').disabled = false;
        }

        // ========================================
        // FUNÇÕES DE ENVIO (Corrigidas)
        // ========================================

        function sendPriceAlert() {
            const asset = document.getElementById('priceAsset').value;
            const newPrice = parseFloat(document.getElementById('priceNew').value);

            if (!asset || isNaN(newPrice)) {
                alert('⚠️ Preencha todos os campos!');
                return;
            }

            // ***** CORREÇÃO (Problema 3) *****
            // Chamada ÚNICA ao HybridEngine. Ele faz todo o processamento.
            const result = HybridEngine.sendPriceUpdate(asset, newPrice);

            // Contar alertas (apenas para feedback)
            const matchedAlerts = JSON.parse(localStorage.getItem('marketPulse_alerts') || '[]')
                .filter(a => a.active && a.asset === asset && a.type === 'price').length;

            // Feedback
            alert(`✅ Alerta enviado!\n\n` +
                  `Ativo: ${asset}\n` +
                  `Variação: ${result.update.variation.toFixed(2)}%\n` +
                  `Preço Anterior: R$ ${result.update.oldPrice.toFixed(2)}\n` +
                  `Preço Novo: R$ ${result.update.newPrice.toFixed(2)}\n` +
                  `Gaps Gerados: ${result.gapsGenerated}\n` +
                  `Acurácia de Sentimento: ${result.analysis.sentiment.accuracy.toFixed(0)}%\n\n` +
                  `⚡ Alertas correspondentes: ${matchedAlerts}\n` +
                  `🕐 Timestamp: ${new Date(result.update.timestamp).toLocaleString('pt-BR')}\n\n` +
                  `ID: ${result.update.id}\n\n` +
                  `💡 O histórico foi atualizado com gaps e análise de sentimento!`);

            // Limpar UI
            document.getElementById('priceAsset').value = '';
            document.getElementById('priceNew').value = '';
            document.getElementById('pricePreview').style.display = 'none';
            document.getElementById('sendPriceBtn').disabled = true;

            loadData();
        }

        function sendNewsAlert() {
            if (!selectedNewsId) {
                alert('⚠️ Selecione uma notícia!');
                return;
            }

            const news = allNews.find(n => n.id === selectedNewsId);
            if (!news) {
                alert('⚠️ Notícia não encontrada!');
                return;
            }
            
            // ***** CORREÇÃO *****
            // Chama o HybridEngine para notícias
            const dispatch = HybridEngine.sendNewsUpdate(selectedNewsId);

            if (!dispatch) {
                alert('⚠️ Erro ao enviar notícia!');
                return;
            }

            const matchedAlerts = JSON.parse(localStorage.getItem('marketPulse_alerts') || '[]')
                .filter(a => a.active && a.asset === news.company && a.type === 'news').length;

            alert(`✅ Notícia enviada!\n\n` +
                  `Ativo: ${news.company}\n` +
                  `Título: ${news.title}\n` +
                  `Impacto: ${news.impact}\n\n` +
                  `⚡ Alertas correspondentes: ${matchedAlerts}\n` +
                  `🕐 Timestamp: ${new Date(dispatch.timestamp).toLocaleString('pt-BR')}\n\n` +
                  `ID: ${dispatch.id}\n\n` +
                  `💡 A notícia agora aparecerá na tela3-noticias com timestamp atual!`);

            selectedNewsId = null;
            document.getElementById('newsSearch').value = '';
            document.getElementById('sendNewsBtn').disabled = true;
            renderNewsList(allNews);

            loadData();
        }

        // ========================================
        // LOAD HISTORY (Layout Ajustado)
        // ========================================
        function loadHistory() {
            const container = document.getElementById('historyList');
            const dispatches = JSON.parse(localStorage.getItem('marketPulse_dispatches') || '[]');

            if (dispatches.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📜</div>
                        <div>Nenhum alerta enviado ainda</div>
                    </div>
                `;
                return;
            }

            const sorted = dispatches.sort((a, b) => b.timestamp - a.timestamp);

            container.innerHTML = sorted.map(dispatch => {
                const date = new Date(dispatch.timestamp);
                
                // AJUSTE 2: Garantir que data E hora/minuto apareçam
                const timeStr = date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let content = '';
                if (dispatch.type === 'price') {
                    const sign = dispatch.variation >= 0 ? '+' : '';
                    const arrow = dispatch.variation >= 0 ? '▲' : '▼';
                    content = `${arrow} ${sign}${dispatch.variation.toFixed(1)}% | R$ ${dispatch.oldPrice.toFixed(2)} → R$ ${dispatch.newPrice.toFixed(2)}`;
                } else {
                    content = `${dispatch.newsTitle.substring(0, 80)}...`;
                }

                // AJUSTE 2: Botão delete na parte inferior
                return `
                    <div class="history-item">
                        <div class="history-header">
                            <span class="history-type">${dispatch.type === 'price' ? '📊 VARIAÇÃO' : '📰 NOTÍCIA'} - ${dispatch.asset}</span>
                            <span class="history-time">${timeStr}</span>
                        </div>
                        <div class="history-content">${content}</div>
                        <div class="history-meta">
                            Operador: ${dispatch.operator} | ID: ${dispatch.id}
                        </div>
                        <button class="delete-btn" onclick="deleteHistoryItem('${dispatch.id}')">Delete</button>
                    </div>
                `;
            }).join('');
        }

        // ========================================
        // FUNÇÕES DE DELETE
        // ========================================
        function deleteHistoryItem(id) {
            if (!confirm('Tem certeza que deseja deletar este item do histórico?')) {
                return;
            }
            let dispatches = JSON.parse(localStorage.getItem('marketPulse_dispatches') || '[]');
            dispatches = dispatches.filter(d => d.id != id);
            localStorage.setItem('marketPulse_dispatches', JSON.stringify(dispatches));
            loadHistory();
            loadData(); 
        }

        function showClearHistoryModal() {
            document.getElementById('clearHistoryModal').style.display = 'flex';
        }

        function hideClearHistoryModal() {
            document.getElementById('clearHistoryModal').style.display = 'none';
        }

        function clearHistory() {
            localStorage.setItem('marketPulse_dispatches', JSON.stringify([]));
            hideClearHistoryModal();
            loadHistory();
            loadData(); 
        }


        // ========================================
        // NAVIGATION
        // ========================================
        function goBack() {
            window.location.href = 'seed-database.html';
        }

        // ========================================
        // INIT
        // ========================================
        window.addEventListener('load', function() {
            console.log('👨‍💼 Market Pulse - Operator Panel v5.1 (Correções)');
            console.log('✅ Sistema carregado');
            console.log('🔧 CORREÇÕES APLICADAS (v5.1):');
            console.log('✅ AJUSTE 1: Botão "Apagar Histórico" movido para topo/esquerda.');
            console.log('✅ AJUSTE 2: Botão "Delete" (item) movido para inferior/esquerda.');
            console.log('✅ AJUSTE 3 (BUG): Lógica de envio de preço refatorada para HybridEngine, corrigindo duplicidade.');

            const users = JSON.parse(localStorage.getItem('marketPulse_users') || '[]');
            if (users.length === 0) {
                alert('⚠️ ATENÇÃO: Banco de dados vazio!\n\n' +
                      'Execute o Seed Database v4.0 primeiro antes de usar o painel do operador.\n\n' +
                      'Clique em "Voltar para Seed Database" e depois em "Gerar Dados v4.0 COMPLETO".');
            }

            loadData();
        });

        // Expor apenas o necessário (se alguma outra tela depender disso)
        // window.DispatchEngine = DispatchEngine; 
    </script>
</body>
</html>


